<!-- IBM Confidential‌ - OCO Source Materials‌ - (C) COPYRIGHT IBM CORP. 2016‌ - The source code for this program is not published or otherwise‌ divested of its trade secrets, irrespective of what has been‌ deposited with the U.S. Copyright Office. -->

<link rel="import" href="../triplat-ds/triplat-ds.html">

<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">

<link rel="import" href="theme.html">

<link rel="import" href="room-reservation-behavior.html">
<link rel="import" href="outlook-behavior.html">

<link rel="import" href="tricomp-array-comparator.html">
<link rel="import" href="tricomp-page-header.html">
<link rel="import" href="tricomp-page-toolbar.html">
<link rel="import" href="tricomp-error-prompt.html">

<link rel="import" href="tripage-reservation-list.html">

<link rel="import" href="tripage-new.html">
<link rel="import" href="tripage-open.html">
<link rel="import" href="tripage-room-criteria.html">
<link rel="import" href="tripage-recurrence.html">
<link rel="import" href="tripage-amenities.html">
<link rel="import" href="tripage-room-results.html">
<link rel="import" href="tripage-room-details.html">
<link rel="import" href="tripage-room-schedule.html">
<link rel="import" href="tripage-room-location.html">
<link rel="import" href="tripage-reservation-summary.html">
<link rel="import" href="tripage-reservation-instructions.html">
<link rel="import" href="tripage-exceptions.html">
<link rel="import" href="tripage-equipment-order.html">
<link rel="import" href="tripage-equipment-details.html">
<link rel="import" href="tripage-food-order.html">
<link rel="import" href="tripage-food-orders-summary.html">

<dom-module id="tricomp-room-reservation">

	<link rel="import" type="css" href="shared.css">

	<style>

		.page-container > * {
			@apply(--layout-fit);
		}

		paper-dialog {
			overflow: auto;
		}

		.save-dialog {
			@apply(--layout-vertical);
			@apply(--layout-center-center);
		}

		.cancel-dialog {
			@apply(--layout-vertical);
			@apply(--layout-center-center);
		}

		paper-dialog > paper-spinner {
			z-index: 8;
		}

	</style>

	<template>

		<triplat-ds id="currentUser" name="currentUser" data="{{currentUser}}"></triplat-ds>
		<!-- <triplat-debug message="tricomp-room-reservation.currentUser" value="[[currentUser]]"></triplat-debug> -->

		<triplat-ds id="favoriteRooms" name="favoriteRooms" data="{{favoriteRooms}}">
			<triplat-ds-context name="currentUser" context-id="[[currentUser._id]]">
			</triplat-ds-context>
		</triplat-ds>
		<!-- <triplat-debug message="tricomp-room-reservation.favoriteRooms" value="[[favoriteRooms]]"></triplat-debug> -->

		<triplat-ds id="myReservationManagers" name="myReservationManagers" data="{{myReservationManagers}}"></triplat-ds>
		<triplat-ds id="myOldReservationManagers" name="myOldReservationManagers" data="{{myOldReservationManagers}}" manual></triplat-ds>

		<triplat-ds id="reservationInstances" name="reservationInstances" data="{{reservationInstances}}" loading="{{reservationInstancesLoading}}" manual>
		</triplat-ds>
		<!-- <triplat-debug message="tricomp-room-reservation.reservationInstances" value="{{reservationInstances}}"></triplat-debug> -->

		<triplat-ds id="reservationManager" name="reservationManager" data="{{reservationManager}}" loading="{{reservationManagerLoading}}" manual>
			<triplat-ds-context name="myReservationManagers" context-id="[[reservationManagerSpecId]]">
			</triplat-ds-context>
		</triplat-ds>
		<!-- <triplat-debug  message="tricomp-room-reservation.reservationManager" value="{{reservationManager}}"></triplat-debug> -->

		<triplat-ds id="reservationManagerInstance" name="reservationManagerInstance" data="{{reservationManagerInstance}}" loading="{{reservationManagerInstanceLoading}}" manual>
			<triplat-ds-context name="myReservationManagers" context-id="[[reservationManagerSpecId]]">
			</triplat-ds-context>
		</triplat-ds>
		<!-- <triplat-debug message="tricomp-room-reservation.reservationManagerInstance" value="{{reservationManagerInstance}}"></triplat-debug> -->

		<triplat-ds id="reservationLocations" name="reservationLocations" data="{{reservationLocations}}" loading="{{reservationLocationsLoading}}" manual>
			<triplat-ds-context name="myReservationManagers" context-id="[[reservationManagerSpecId]]">
			</triplat-ds-context>
		</triplat-ds>
		<!-- <triplat-debug message="tricomp-room-reservation.reservationLocations" value="{{reservationLocations}}"></triplat-debug> -->

		<triplat-ds id="exceptionOccurrences" name="exceptionOccurrences" data="{{exceptionOccurrences}}" loading="{{exceptionOccurrencesLoading}}" manual>
			<triplat-ds-context name="myReservationManagers" context-id="[[reservationManagerSpecId]]">
			</triplat-ds-context>
		</triplat-ds>
		<!-- <triplat-debug message="tricomp-room-reservation.exceptionOccurrences" value="{{exceptionOccurrences}}"></triplat-debug> -->

		<!-- <triplat-debug message="tricomp-room-reservation.isBusy" value="[[isBusy]]"></triplat-debug> -->

		<div>

			<iron-pages class="page-container" attr-for-selected="id" selected="{{currentPage}}">

				<tripage-reservation-list
					id="reservationListPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]">
				</tripage-reservation-list>

				<tripage-new
					id="newPage"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					spec-id="[[reservationManagerSpecId]]"
					pre-create-complete="[[preCreateComplete]]">
				</tripage-new>

				<tripage-open
					id="openPage"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					spec-id="[[reservationManagerSpecId]]"
					pre-create-complete="[[preCreateComplete]]">
				</tripage-open>

				<tripage-room-criteria
					id="roomCriteriaPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-room-criteria>

				<tripage-amenities
					id="criteriaAmenitiesPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-amenities>

				<tripage-recurrence
					id="recurrencePage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-recurrence>

				<tripage-room-results
					id="roomResultsPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-room-results>

				<tripage-room-details
					id="roomDetailsPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-room-details>

				<tripage-room-schedule
					id="roomSchedulePage"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					is-busy="{{isBusy}}"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-room-schedule>

				<tripage-room-location
					id="roomLocationPage"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					is-busy="{{isBusy}}"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-room-location>

				<tripage-reservation-summary
					id="reservationSummaryPage"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					is-busy="{{isBusy}}"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-reservation-summary>

				<tripage-reservation-instructions
					id="reservationInstructionsPage"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					is-busy="{{isBusy}}"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-reservation-instructions>

				<tripage-exceptions
					id="exceptionsPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-exceptions>

				<tripage-equipment-order
					id="equipmentOrderPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					order-id="{{orderId}}"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-equipment-order>

				<tripage-equipment-details
					id="equipmentDetailsPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-equipment-details>

				<tripage-food-orders-summary
					id="foodOrdersSummaryPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-food-orders-summary>

				<tripage-food-order
					id="foodOrderPage"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					order-id="{{orderId}}"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-food-order>

				<tripage-food-order
					id="foodOrderPageNew"
					is-busy="{{isBusy}}"
					is-outlook-embedded="[[isOutlookEmbedded]]"
					order-id="{{orderId}}"
					resource-id="[[resourceId]]"
					spec-id="[[reservationManagerSpecId]]">
				</tripage-food-order>

			</iron-pages>

		</div>

		<paper-toast id="toast" text=""></paper-toast>

		<paper-dialog id="saveDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop class="save-dialog">
			<p>Please wait while we save your reservation.</p>
			<paper-spinner active></paper-spinner>
		</paper-dialog>

		<paper-dialog id="cancelDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop class="cancel-dialog">
			<p>Please wait while we cancel your reservation.</p>
			<paper-spinner active></paper-spinner>
		</paper-dialog>

		<paper-dialog modal with-backdrop id="errorDialog" class="error-dialog">
			<tricomp-error-prompt error-details="{{_errorDetails}}" is-admin="{{currentUser._Admin}}" on-error-details-collapse-or-expand="_handleErrorDetailsCollapseOrExpand"></tricomp-error-prompt>
		</paper-dialog>

	</template>
</dom-module>
<script>

	Polymer({
		is: "tricomp-room-reservation",

		behaviors: [TriPlatViewBehavior, RoomReservationBehavior, OutlookBehavior],

		properties: {
			reservationManager: Object,
			reservationLocations: Array,
			exceptionOccurrences: Array,
			// exchangeAppointment: Object,
			// exchangeResponse: Object,
			// reservationManagerEXC: Object,

			orderId: {
				type: String,
				notify: true,
				value: "-1",
			},

			resourceId: {
				type: String,
				notify: true,
				value: "-1",
			},

			currentReservationId: {
				type: String,
				value: null,
			},

			initstart: Date,
			initend: Date,

			reservationManagerSpecId: {
				type: String,
				value: null,
			},

			isPreCreating: {
				type: Boolean,
				value: false,
				observer: '_calcPreCreateComplete',
			},

			preCreateComplete: {
				type: Boolean,
				value: false,
			},

			reservationManagerLoading: {
				type: Boolean,
				value: true,
			},

			entryAnimation: {
				type: String,
				value: "slide-from-right-animation",
			},

			exitAnimation: {
				type: String,
				value: "slide-left-animation",
			},

			reservationInstructions: String,

			currentPage: {
				type: String,
			}
		},

		listeners: {
			"start-over": "_handleStartOver",

			"init": "_init",
			"open": "_open",

			"navigate-start": "_handleStart",
			"navigate-start-new": "_handleStartNew",

			"navigate-room-criteria": "_handleRoomCriteriaPage",
			"navigate-room-criteria-back": "_handleRoomCriteriaPageBack",
			"navigate-room-criteria-dramatic": "_handleRoomCriteriaPageDramatic",

			"navigate-criteria-amenities": "_handleCriteriaAmenitiesPage",
			"navigate-criteria-amenities-back": "_handleCriteriaAmenitiesPageBack",

			"navigate-recurrence": "_handleRecurrencePage",

			"navigate-summary-instructions": "_handleSummaryInstructions",
			"navigate-instructions-summary-back": "_handleSummaryInstructionsBack",

			"navigate-reservation-list": "_handleReservationList",
			"navigate-reservation-open": "_handleReservationOpen",
			"navigate-reservation-new": "_handleReservationNew",

			"navigate-room-results": "_handleRoomResultsPage",
			"navigate-room-results-back": "_handleRoomResultsPageBack",
			"navigate-room-results-dramatic": "_handleRoomResultsPageDramatic",

			"navigate-room-details": "_handleRoomDetailsPage",
			"navigate-room-details-back": "_handleRoomDetailsPageBack",
			"navigate-room-schedule": "_handleRoomSchedulePage",
			"navigate-room-location": "_handleRoomLocationPage",

			"navigate-booked-room-details": "_handleBookedRoomDetailsPage",

			"navigate-summary-page": "_handleSummaryPage",
			"navigate-summary-page-back": "_handleSummaryPageBack",

			"navigate-exceptions": "_handleExceptionsPage",
			"navigate-exceptions-back": "_handleExceptionsPageBack",

			"navigate-equipment-order": "_handleEquipmentOrderPage",
			"navigate-equipment-order-back": "_handleEquipmentOrderPageBack",

			"navigate-equipment-details": "_handleEquipmentDetailsPage",

			"navigate-food-order": "_handleFoodOrderPage",
			"navigate-food-order-add": "_handleFoodOrderAddPage",
			"navigate-food-orders-summary": "_handleFoodOrdersSummaryPage",
			"navigate-food-orders-summary-page-back": "_handleFoodOrdersSummaryPageBack",

			"action-book-room": "_handleBookRoom",
			"action-waitlist-room": "_handleWaitListRoom",
			"action-toggle-room-favorite": "_handleToggleRoomFavorite",

			"action-exception-assign": "_handleExceptionAssign",
			"action-exception-auto-assign": "_handleExceptionAutoAssign",
			"action-exception-auto-assign-all": "_handleExceptionAutoAssignAll",
			"action-exception-clear-assignment": "_handleExceptionClearAssignment",
			"action-exception-clear-assignment-all": "_handleExceptionClearAssignmentAll",

			"action-submit": "_handleSubmit",
			"action-cancel": "_handleCancel",
			"action-cancel-from-list": "_handleCancelFromList",

			"action-checkin": "_handleCheckIn",
			"action-checkin-from-list": "_handleCheckInFromList",
			"action-checkout": "_handleCheckOut",
			"action-checkout-from-list": "_handleCheckOutFromList",
			"action-earlyend": "_handleEarlyEnd",
			"action-earlyend-from-list": "_handleEarlyEndFromList",

			"action-booked-room-remove": "_handleBookedRoomRemove",

			"action-equipment-order-cancel": "_handleEquipmentOrderCancel",
			"action-food-order-cancel": "_handleFoodOrderCancel",

			"refresh-reservation-list": "_refreshReservationList",
			"refresh-equipment-orders": "_refreshEquipmentOrdersData",

			"ds-add-error": "_handleDSError",
			"ds-create-error": "_handleDSError",
			"ds-delete-error": "_handleDSError",
			"ds-get-error": "_handleDSError",
			"ds-perform-action-error": "_handleDSError",
			"ds-remove-error": "_handleDSError",
			"ds-update-error": "_handleDSError",
		},

		_getDefaultStartDate: function() {
			// console.log("_getDefaultStartDate");
			var returnValue = null;

			if (this.isOutlookEmbedded) {
				// console.log(this.outlookDataObserver);
				// console.log(this.outlookDataObserver.startDate);

				if (this.outlookDataObserver && this.outlookDataObserver.startDate) {
					returnValue = this.outlookDataObserver.startDate;
				} else {
					console.log("*** generating a new date because there is no outlookDataObserver.startDate");
					returnValue = new Date();
				}
			} else {
				returnValue = new Date();
			}

			// console.log(returnValue);

			return returnValue;
		},

		_getDefaultEndDate: function() {
			// console.log("_getDefaultEndDate");
			var returnValue = null;

			if (this.isOutlookEmbedded) {
				// console.log(this.outlookDataObserver);
				// console.log(this.outlookDataObserver.endDate);

				if (this.outlookDataObserver && this.outlookDataObserver.endDate) {
					returnValue = this.outlookDataObserver.endDate;
				} else {
					console.log("*** generating a new date because there is no outlookDataObserver.endDate");
					returnValue = new Date();
				}
			} else {
				returnValue = new Date();
			}

			// console.log(returnValue);

			return returnValue;
		},

		_getDefaultSubject: function() {
			// console.log("_getDefaultSubject");
			var returnValue = null;

			if (this.isOutlookEmbedded) {
				if (this.outlookDataObserver && this.outlookDataObserver.subject) {
					returnValue = this.outlookDataObserver.subject;
				} else {
					returnValue = "";
				}
			} else {
				returnValue = "";
			}

			// console.log(returnValue);

			return returnValue;
		},

		_isBusy: function(isBusy) {
			return isBusy;
		},

		_calcPreCreateComplete: function() {
			if (this.preCreateComplete) {
				this.set("initend", new Date());

				// console.log("Initialization End: " + this.initend);
				// console.log("Initialization Duration: " + (this.initend.getSeconds() - this.initstart.getSeconds()) + " seconds...");
			}
		},

		_handleStartOver: function() {
			// console.log("_handleStartOver");
			if (!this.isPreCreating) {
				this.initReservation();
			}
		},

		_handleStartNew: function() {
			// console.log("_handleStart");
			if (this.reservationManagerSpecId) {
				this._handleRoomCriteriaPage();
			} else {
				this._handlePreCreateErrorPage();
			}
		},

		_handleStart: function() {
			// console.log("_handleStart");
			if (this.reservationManagerSpecId) {
				this._handleSummaryPage();
			} else {
				this._handlePreCreateErrorPage();
			}
		},

		_handleRoomCriteriaPage: function() {
			// console.log("_handleRoomCriteriaPage");
			this._navigate(this.$.roomCriteriaPage);
		},

		_handleRoomCriteriaPageBack: function() {
			// console.log("_handleRoomCriteriaPageBack");
			this._navigate(this.$.roomCriteriaPage);
		},

		_handleRoomCriteriaPageDramatic: function() {
			// console.log("_handleRoomCriteriaPageDramatic");
			this._navigate(this.$.roomCriteriaPage);
		},

		_handleCriteriaAmenitiesPage: function(e) {
			// console.log("_handleCriteriaAmenitiesPage");
			var backEventName = e.detail.backEventName;
			this.$.criteriaAmenitiesPage.backEventName = backEventName;
			this._navigate(this.$.criteriaAmenitiesPage);
		},

		_handleCriteriaAmenitiesPageBack: function() {
			// console.log("_handleCriteriaAmenitiesPageBack");
			this._navigate(this.$.criteriaAmenitiesPage);
		},

		_handleRecurrencePage: function(e) {
			// console.log("_handleRecurrencePage");
			var backEventName = e.detail.backEventName;
			this.$.recurrencePage.backEventName = backEventName;
			this._navigate(this.$.recurrencePage);
		},

		_handleSummaryInstructions: function(e) {
			this._navigate(this.$.reservationInstructionsPage);
		},

		_handleSummaryInstructionsBack: function(e) {
			this._navigate(this.$.reservationSummaryPage);
		},

		_handleRoomResultsPageDramatic: function(e) {
			// console.log("_handleRoomResultsPageDramatic");
			var backEventName = e.detail.backEventName;
			this.$.roomResultsPage.backEventName = backEventName;
			var occurrenceId = e.detail.occurrenceId;
			this.$.roomResultsPage.occurrenceId = occurrenceId;
			var occurrenceDate = e.detail.occurrenceDate;
			this.$.roomResultsPage.occurrenceDate = occurrenceDate == undefined ? null : occurrenceDate;
			this._navigate(this.$.roomResultsPage);
		},

		_handleRoomResultsPage: function(e) {
			// console.log("_handleRoomResultsPage");
			var backEventName = e.detail.backEventName;
			this.$.roomResultsPage.backEventName = backEventName;
			var occurrenceId = e.detail.occurrenceId;
			this.$.roomResultsPage.occurrenceId = occurrenceId;
			var occurrenceDate = e.detail.occurrenceDate;
			this.$.roomResultsPage.occurrenceDate = occurrenceDate == undefined ? null : occurrenceDate;
			this._navigate(this.$.roomResultsPage);
		},

		_handleRoomResultsPageBack: function() {
			// console.log("_handleRoomResultsPageBack");
			this._navigate(this.$.roomResultsPage);
		},		

		_handleRoomDetailsPage: function(e) {
			// console.log("_handleRoomDetailsPage");

			var roomId = e.detail.roomId;
			var backEventName = e.detail.backEventName;
			var resourceId = e.detail.resourceId;
			this.set("resourceId", resourceId);
			this.$.roomDetailsPage.backEventName = backEventName;
			this._navigate(this.$.roomDetailsPage, { 'roomId': roomId });
		},

		_handleExceptionsPage: function(e) {
			// console.log("_handleExceptionsPage");

			var resourceId = e.detail.resourceId;
			this._setResourceOrder(resourceId, null);

			this._navigate(this.$.exceptionsPage);
		},

		_handleExceptionsPageBack: function(e) {
			// console.log("_handleExceptionsPageBack");
			this._navigate(this.$.exceptionsPage);
		},

		_handleEquipmentOrderPage: function(e) {
			// console.log("_handleEquipmentOrderPage");

			var resourceId = e.detail.resourceId;
			var orderId = e.detail.orderId;
			this._setResourceOrder(resourceId, orderId);

			this._navigate(this.$.equipmentOrderPage);
		},

		_handleEquipmentOrderPageBack: function(e) {
			// console.log("_handleEquipmentOrderPageBack");

			// var resourceId = e.detail.resourceId;
			// var orderId = e.detail.orderId;
			// this._setResourceOrder(resourceId, orderId);

			this._navigate(this.$.equipmentOrderPage);
		},

		_handleEquipmentDetailsPage: function(e) {
			// console.log("_handleEquipmentDetailsPage");

			var equipmentId = e.detail.equipmentId;
			// var roomId = e.detail.roomId;
			this._navigate(this.$.equipmentDetailsPage, {equipmentId: equipmentId});
		},

		_handleFoodOrderPage: function(e) {
			// console.log("_handleFoodOrderPage");

			var resourceId = e.detail.resourceId;
			var orderId = e.detail.orderId;
			this._setResourceOrder(resourceId, orderId);

			this._navigate(this.$.foodOrderPage);
		},

		_handleFoodOrderAddPage: function(e) {
			// console.log("_handleFoodOrderAddPage");

			var resourceId = e.detail.resourceId;
			var orderId = "-1";
			this._setResourceOrder(resourceId, orderId);

			this._navigate(this.$.foodOrderPage);
			// this._navigate(this.$.foodOrderNewPage);
		},

		_handleFoodOrdersSummaryPage: function(e) {
			// console.log("_handleFoodOrdersSummaryPage");

			var resourceId = e.detail.resourceId;
			this.set("resourceId", resourceId);
			
			this._navigate(this.$.foodOrdersSummaryPage);
		},

		_handleFoodOrdersSummaryPageBack: function(e) {
			// console.log("_handleFoodOrdersSummaryPage");
			
			this._navigate(this.$.foodOrdersSummaryPage);
		},

		_setResourceOrder: function(resourceId, orderId) {
			// this.resourceId = resourceId;
			// this.orderId = orderId;

			this.set("resourceId", resourceId);
			this.set("orderId", orderId);
		},

		_handleReservationList: function() {
			// console.log("_handleReservationList");
			if (this.reservationManager) {
				this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "cleanup").then(function() {
					this._navigate(this.$.reservationListPage);
					this._refreshReservationList();
				}.bind(this));					
			} else {
				this._navigate(this.$.reservationListPage);
				this._refreshReservationList();
			}
		},

		_handleRoomDetailsPageBack: function(e) {
			// console.log("_handleRoomDetailsPageBack");

			var roomId = e.detail.roomId;
			this._navigate(this.$.roomDetailsPage, {roomId: roomId});
		},

		_handleRoomSchedulePage: function(e) {
			// console.log("_handleRoomDetailsSchedulePage");

			var roomId = e.detail.roomId;
			this._navigate(this.$.roomSchedulePage, {roomId: roomId});
		},

		_handleRoomLocationPage: function(e) {
			// console.log("_handleRoomDetailsLocationPage");

			var roomId = e.detail.roomId;
			this._navigate(this.$.roomLocationPage, {roomId: roomId});
		},

		_handleSummaryPage: function(e) {
			// console.log("_handleSummaryPage");
			this._navigate(this.$.reservationSummaryPage);
		},

		_handleSummaryPageBack: function(e) {
			// console.log("_handleSummaryPageBack");
			this._navigate(this.$.reservationSummaryPage);
		},

		_handlePreCreateErrorPage: function(e) {
			// console.log("_handlePreCreateErrorPage");
			this._navigate(this.$.reservationInitFailPage);
		},

		_handleBookRoom: function(e) {
			// console.log("_handleBookRoom");
			var roomId = e.detail.roomId;
			// console.log("roomId: " + roomId);

			this._setBusy();

			var wfParams = {};
			wfParams.rooms = roomId;

			this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "bookSelectedRoom", wfParams).then(function() {
				// console.log("_handleBookRoom COMPLETE");

				this.$.reservationLocations.refresh().then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-summary-page");
							this._addRoomSuccess();
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}.bind(this));
		},

		_handleExceptionAssign: function(e) {
			// console.log("_handleExceptionAssign");
			var occurrenceId = e.detail.occurrenceId;
			var roomId = e.detail.roomId;

			if (occurrenceId && roomId && this.resourceId) {
				this._setBusy();

				var wfParams = {};
				wfParams.occurrence = occurrenceId;
				wfParams.location = roomId;

				this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "exceptionAssignLocation", wfParams).then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-exceptions", { 'resourceId' : this.resourceId });
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}
		},

		_handleExceptionAutoAssign: function(e) {
			// console.log("_handleExceptionAutoAssign");
			var occurrenceId = e.detail.occurrenceId;

			if (occurrenceId && this.resourceId) {
				this._setBusy();

				var wfParams = {};
				wfParams.occurrence = occurrenceId;

				this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "exceptionAutoAssignLocation", wfParams).then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-exceptions", { 'resourceId' : this.resourceId });
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}
		},

		_handleExceptionAutoAssignAll: function(e) {
			// console.log("_handleExceptionAutoAssignAll");
			if (this.resourceId) {
				this._setBusy();

				var wfParams = {};
				wfParams.resource = this.resourceId;

				this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "exceptionAutoAssignAll", wfParams).then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-exceptions", { 'resourceId' : this.resourceId });
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}
		},

		_handleExceptionClearAssignment: function(e) {
			// console.log("_handleExceptionClearAssignment");
			var occurrenceId = e.detail.occurrenceId;

			if (occurrenceId && this.resourceId) {
				this._setBusy();

				var wfParams = {};
				wfParams.occurrence = occurrenceId;
				wfParams.resource = this.resourceId;

				this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "exceptionClearAssignment", wfParams).then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-exceptions", { 'resourceId' : this.resourceId });
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}
		},

		_handleExceptionClearAssignmentAll: function(e) {
			// console.log("_handleExceptionClearAssignmentAll");
			if (this.resourceId) {
				this._setBusy();

				var wfParams = {};
				wfParams.resource = this.resourceId;

				this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "exceptionClearAssignment", wfParams).then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-exceptions", { 'resourceId' : this.resourceId });
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}
		},

		_addRoomSuccess: function() {
			// this.$.toast.text = "Room Added";
			// this.$.toast.show();
		},

		_handleBookedRoomRemove: function(e) {
			// console.log("_handleBookedRoomRemove");
			var resourceId = e.detail.bookedRoomId;
			// console.log("resourceId: " + resourceId);

			this._setBusy();

			var wfParams = {};
			wfParams.resource = resourceId;

			this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "removeBookedRoom", wfParams).then(function() {
				// console.log("_handleBookedRoomRemove COMPLETE");

				this.$.reservationLocations.refresh().then(function() {
					this.$.exceptionOccurrences.refresh().then(function() {
						this.async(function() {
							this.fire("navigate-summary-page");
							this._removeRoomSuccess();
						});

						this._clearBusy();
					}.bind(this));
				}.bind(this));
			}.bind(this));
		},

		_removeRoomSuccess: function() {
			// this.$.toast.text = "Room Removed";
			// this.$.toast.show();
		},

		_handleToggleRoomFavorite: function(e) {
			// console.log("_handleToggleRoomFavorite");
			// console.log(e);

			var roomId = e.detail.roomId;
			if (!roomId) {
				return;
			}

			// this._setBusy();

			var isFavorite = e.detail.isFavorite;

			var selectedRoom = {_id: roomId};
			// console.log(selectedRoom);

			if (isFavorite) {
				// console.log("adding room [" + selectedRoom._id + "] to favorites...");
				// this.$.favoriteRooms.removeRecord(selectedRoom).then(function() {
					this.$.favoriteRooms.addRecord(selectedRoom, TriPlatDs.RefreshType.CLIENT).then(function() {
						// this.$.favoriteRooms.refresh().then(function() {
							// this._clearBusy();
						// }.bind(this));
					}.bind(this));
				// }.bind(this));
			} else {
				// console.log("removing room [" + selectedRoom._id + "] from favorites...");
				this.$.favoriteRooms.removeRecord(selectedRoom, TriPlatDs.RefreshType.CLIENT).then(function() {
					// this.$.favoriteRooms.refresh().then(function() {
						// this._clearBusy();
					// }.bind(this));
				}.bind(this));
			}
		},

		_handleSubmit: function(e) {
			// console.log("_handleSubmit");

			this._setBusy();

			var wfParams = {};
			if (this.reservationManager.reservation != null && this.reservationManager.reservation.id) {
				wfParams.reservation = this.reservationManager.reservation.id;
			}

			this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "isChanged", wfParams).then(function() {
				this._clearBusy();

				if (this.reservationManager.isDirty) {

					this.$.saveDialog.open();

					this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "submit").then(function() {

						// console.log("_handleSubmit COMPLETE");

						this.$.reservationLocations.refresh().then(function() {
							this.$.exceptionOccurrences.refresh().then(function() {
								this.$.reservationManagerInstance.refresh().then(function() {
									this.$.saveDialog.close();

									this.async(function() {
										this._submitSuccess();

										// this._clearBusy();

										this._handleReservationList();
									});
								}.bind(this));
							}.bind(this));
						}.bind(this));
					}.bind(this));
				} else {
					this._handleNavigateList();
				}
			}.bind(this));
		},

		_submitSuccess: function() {
			this.$.toast.text = "Reservation Saved";
			this.$.toast.show();
		},

		_handleCancel: function(e) {
			// console.log("_handleCancel");
			// console.log(e);

			// this._setBusy();

			this.$.cancelDialog.open();

			this._cancelRM().then(function() {

				this.$.cancelDialog.close();

				// console.log("_handleCancel COMPLETE");

				this.$.reservationLocations.refresh().then(function() {
					this.async(function() {
						this._cancelSuccess();

						// this._refreshReservationList();

						// this._clearBusy();

						this._handleReservationList();
					});
				}.bind(this));
			}.bind(this));
		},

		_handleCancelFromList: function(e) {
			// console.log("_handleCancelFromList");
			// console.log(e);

			var reservationId = e.detail.reservationId;
			// console.log("reservationId: " + reservationId);

			var occurrenceStart = e.detail.occurrenceStart;
			this.set("occurrenceStart", occurrenceStart);
			// console.log("occurrenceStart: " + occurrenceStart);
			var occurrenceEnd = e.detail.occurrenceEnd;
			this.set("occurrenceEnd", occurrenceEnd);
			// console.log("occurrenceEnd: " + occurrenceEnd);

			// this._setBusy();

			this.$.cancelDialog.open();

			this._openRM(reservationId).then(function() {
				this._cancelRM().then(function() {

					this.$.cancelDialog.close();

					// console.log("_handleCancelFromList COMPLETE");

					this.$.reservationLocations.refresh().then(function() {
						this.async(function() {
							this._cancelSuccess();

							// this._refreshReservationList();

							// this._clearBusy();

							this._handleReservationList();
						});
					}.bind(this));
				}.bind(this));
			}.bind(this));
		},

		_cancelSuccess: function() {
			this.$.toast.text = "Reservation Cancelled";
			this.$.toast.show();
		},

		_handleCheckIn: function(e) {
			// console.log("_handleCheckIn");

			this._setBusy();

			this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "check-in").then(function() {

				// console.log("_handleCheckIn COMPLETE");

				// this.$.reservationLocations.refresh().then(function() {
					this.async(function() {
						this._checkinSuccess();

						this._refreshReservationList();

						this._clearBusy();
					});
				// }.bind(this));
			}.bind(this));
		},

		_handleCheckInFromList: function(e) {
			// console.log("_handleCheckInFromList");
			var instanceId = e.detail.instanceId;
			// console.log("instanceId: " + instanceId);

			this._setBusy();

			this.$.reservationInstances.performAction(instanceId, TriPlatDs.RefreshType.NONE, "actions", "check-in").then(function() {
					this.async(function() {
						this._checkinSuccess();

						this._refreshReservationList();

						this._clearBusy();
					});
			}.bind(this));
		},

		_checkinSuccess: function() {
			this.$.toast.text = "You are checked-in.";
			this.$.toast.show();
		},

		_handleCheckOut: function(e) {
			// console.log("_handleCheckOut");

			this._setBusy();

			this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "check-out").then(function() {

				// console.log("_handleCheckOut COMPLETE");

				// this.$.reservationLocations.refresh().then(function() {
					this.async(function() {
						this._checkoutSuccess();

						this._refreshReservationList();

						this._clearBusy();
					});
				// }.bind(this));
			}.bind(this));
		},

		_handleCheckOutFromList: function(e) {
			// console.log("_handleCheckOutFromList");
			var instanceId = e.detail.instanceId;
			// console.log("instanceId: " + instanceId);

			this._setBusy();

			this.$.reservationInstances.performAction(instanceId, TriPlatDs.RefreshType.NONE, "actions", "check-out").then(function() {
					this.async(function() {
						this._checkoutSuccess();

						this._refreshReservationList();

						this._clearBusy();
					});
			}.bind(this));
		},

		_checkoutSuccess: function() {
			this.$.toast.text = "You have been checked-out.";
			this.$.toast.show();
		},

		_handleEarlyEnd: function(e) {
			// console.log("_handleEarlyEnd");

			this._setBusy();

			this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "early-end").then(function() {

				// console.log("_handleEarlyEnd COMPLETE");

				// this.$.reservationLocations.refresh().then(function() {
					this.async(function() {
						this._earlyendSuccess();

						this._refreshReservationList();

						this._clearBusy();
					});
				// }.bind(this));
			}.bind(this));
		},

		_handleEarlyEndFromList: function(e) {
			// console.log("_handleEarlyEndFromList");
			var instanceId = e.detail.instanceId;
			// console.log("instanceId: " + instanceId);

			this._setBusy();

			this.$.reservationInstances.performAction(instanceId, TriPlatDs.RefreshType.NONE, "actions", "early-end").then(function() {
					this.async(function() {
						this._earlyendSuccess();

						this._refreshReservationList();

						this._clearBusy();
					});
			}.bind(this));
		},

		_earlyendSuccess: function() {
			this.$.toast.text = "Your meeting has been ended early.";
			this.$.toast.show();
		},

		_handleWaitListRoom: function(e) {
			// console.log("_handleWaitListRoom");
			var roomId = e.detail.roomId;
		},

		_handleEquipmentOrderCancel: function(e) {
			// console.log("_handleEquipmentOrderCancel");
			var orderId = e.detail.orderId;
			// console.log("orderId", orderId);

			this._setBusy();

			var wfParams = {};
			wfParams.orders = orderId;

			// console.log("wfParams", wfParams);

			this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "cancelEquipment", wfParams).then(function() {
				this.async(function() {
					this.fire("navigate-summary-page");
					this._cancelEquipmentOrderSuccess();
					this._refreshEquipmentOrdersData();
				});

				this._clearBusy();
			}.bind(this));
		},

		_cancelEquipmentOrderSuccess: function() {
			this.$.toast.text = "Equipment Order cancelled.";
			this.$.toast.show();
		},

		_handleFoodOrderCancel: function(e) {
			// console.log("_handleFoodOrderCancel");
			var orderId = e.detail.orderId;
			// console.log("orderId", orderId);

			this._setBusy();

			var wfParams = {};
			wfParams.orders = orderId;

			// console.log("wfParams", wfParams);

			this.$.reservationManager.updateRecord(this.reservationManager._id, TriPlatDs.RefreshType.SERVER, "actions", "cancelFood", wfParams).then(function() {
				this.async(function() {
					this.fire("navigate-summary-page");
					this._cancelFoodOrderSuccess();
					this._refreshFoodOrdersData();
				});

				this._clearBusy();
			}.bind(this));
		},

		_cancelFoodOrderSuccess: function() {
			this.$.toast.text = "Food Order cancelled.";
			this.$.toast.show();
		},

		_handleReservationOpen: function(e) {
			// console.log("_handleReservationOpen");
			if (this.isPreCreating) {
				return;
			}

			var reservationId = e.detail.reservationId;
			// console.log("reservationId: " + reservationId);
			var occurrenceStart = e.detail.occurrenceStart;
			this.set("occurrenceStart", occurrenceStart);
			// console.log("occurrenceStart: " + occurrenceStart);
			var occurrenceEnd = e.detail.occurrenceEnd;
			this.set("occurrenceEnd", occurrenceEnd);
			// console.log("occurrenceEnd: " + occurrenceEnd);
			var iCalUID = e.detail.iCalUID;
			// console.log("iCalUID: " + iCalUID);

			this.set("currentReservationId", reservationId);
			// this.set("iCalUID", iCalUID);

			if (this.reservationManagerSpecId) {
				// show the open reservation page while we reset the reservation manager context
				this._navigate(this.$.openPage);

				this._openReservation(reservationId).then(function() {
					this.async(function() {
						this.fire("navigate-summary-page");
					});
				}.bind(this));
			} else {
				this._handleReservationOpenFirstTime();
			}
		},

		_openReservation: function(reservationId) {
			return new Promise(function(resolve) {
				this.reservationManager.userMessage = "";

				this.reservationManager.reservationStartTime = this.occurrenceStart;
				this.reservationManager.reservationEndTime = this.occurrenceEnd;

				var wfParams = {};
				wfParams.reservation = reservationId;

				this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "resetContext", wfParams).then(function() {
					this.$.reservationLocations.refresh().then(function() {
						this.$.exceptionOccurrences.refresh().then(function() {
							this.$.reservationManagerInstance.refresh().then(function() {
								resolve();
							}.bind(this));
						}.bind(this));
					}.bind(this));
				}.bind(this));
			}.bind(this));
		},

		_handleReservationOpenFirstTime: function() {
			// console.log("_handleReservationOpenFirstTime");

			// this.set("reservationManagerSpecId", null);
			this.set("userInterfaceID", this._getUserInterfaceID());

			this._navigate(this.$.openPage);
		},

		_handleReservationNew: function(e) {
			// console.log("_handleReservationNew");

			if (this.isPreCreating) {
				return;
			}

			this.set("currentReservationId", null);

			if (!this.isOutlookEmbedded) {
				this.set("reservationManager.iCalUID", null);
				this.set("reservationManager.iCALSequence", 0);
			}

			// this._setResourceOrder("-1", "-1");

			if (this.reservationManagerSpecId) {
				// show the new reservation page while we reset the reservation manager form
				this._navigate(this.$.newPage);

				// console.log("_handleReservationNew: calling resetContext workflow");
				this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "resetContext").then(function() {
					this.$.reservationLocations.refresh().then(function() {
						this.$.exceptionOccurrences.refresh().then(function() {
							this.$.reservationManagerInstance.refresh().then(function() {
								this.async(function() {
									this.fire("navigate-room-criteria");
								});
							}.bind(this));
						}.bind(this));
					}.bind(this));
				}.bind(this));

			} else {
				this._handleReservationNewFirstTime(e);
			}
		},

		_handleReservationNewFirstTime: function(e) {
			// console.log("_handleReservationNewFirstTime");

			// this.set("reservationManagerSpecId", null);
			this.set("userInterfaceID", this._getUserInterfaceID());

			this._navigate(this.$.newPage);
		},

		_init : function() {
			// console.log("tricomp-room-reservation._init");

			if (!this.userInterfaceID) {
				if (this.isOutlookEmbedded) {
					this.fire("navigate-reservation-open");

					this.async(function() {
						this._handleStartOver();
						// this._handleReservationNew();
					});
				} else {
					this.async(function() {
						this.fire("navigate-reservation-list");
					});
				}
			} else {
				this._handleStartOver();
			}
		},

		_open : function() {
			// console.log("tricomp-room-reservation._open");

			if (!this.userInterfaceID) {
				this.fire("navigate-reservation-list");
			} else {
				this.async(function() {
					this._handleStartOver();
				});
			}
		},

		initReservation : function() {
			// console.log("tricomp-room-reservation.initReservation");

			if (this.reservationManagerSpecId) {
				// console.log("reinitializing existing Reservation Manager - " + this.reservationManagerSpecId);
				this._setBusy();

				var wfParams = {};
				if (this.reservationManager && this.reservationManager.reservation && this.reservationManager.reservation.id) {
					wfParams.reservation = this.reservationManager.reservation.id;
				}

				// console.log("initReservation: calling resetContext workflow");
				this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "resetContext", wfParams).then(function() {
					this.$.reservationLocations.refresh().then(function() {
						this.$.exceptionOccurrences.refresh().then(function() {
							this.$.reservationManagerInstance.refresh().then(function() {
								this._clearBusy();
							}.bind(this));
						}.bind(this));
					}.bind(this));
				}.bind(this));

			} else {
				this._initReservation();
			}
		},

		_initReservation : function() {
			// console.log("tricomp-room-reservation._initReservation");

			this.set("reservationManagerSpecId", null);
			this.set("initstart", new Date());

			// console.log("Initialization Start: " + this.initstart);
			// this.preCreate();

			if (!this.isPreCreating) {
				this._preCreateStart();

				this._preCreate_RM().then(function() {
					// console.log("preCreate COMPLETE");

					this._preCreateComplete();
				}.bind(this));				
			}
		},

		_preCreateStart: function() {
			// console.log("_preCreateStart");
			this.set("preCreateComplete", false);
			this.set("isPreCreating", true);
		},

		_preCreateComplete: function() {
			// console.log("_preCreateComplete");
			this.async(function() {
				this.set("preCreateComplete", true);
				this.set("isPreCreating", false);

				this._clearBusy();
			});
		},

		_openRM: function(reservationId) {

			return new Promise(function(resolve) {
				if (!this.reservationManager) {
					this._createRM(reservationId).then(function() {
						resolve();
					}.bind(this));
				} else {
					this._openReservation(reservationId).then(function() {
						resolve();
					}.bind(this));
				}
			}.bind(this));
		},

		_cancelRM: function() {

			return new Promise(function(resolve) {
				this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "cancel").then(function() {
					this.set("currentReservationId", null);

					resolve();
				}.bind(this));
			}.bind(this));
		},

		_preCreate_RM : function() {
			// console.log("tricomp-room-reservation._preCreate_RM");

			return new Promise(function(resolve) {

				// this._preCreateStart();

				this._createRM(this.currentReservationId).then(function() {
					if (this.currentReservationId) {
						this.async(function() {
							this.fire("navigate-summary-page");

							// this._preCreateComplete();
						});

						resolve();						
					} else {
						// this._preCreateComplete();
						resolve();						
					}
				}.bind(this));
			}.bind(this));
		},

		_createRM: function(reservationId) {
			// console.log("tricomp-room-reservation._createRM");

			return new Promise(function(resolve) {

				if (this.isOutlookEmbedded) {
					// console.log("pre-creating ReservationManager using ExchangeAppointment method");

					// var preCreateExchangeAppointment = {
					// 	iCalUID: this._getiCalUID(),
					// 	userInterfaceID: this._getUserInterfaceID(),
					// 	actionType: "TAB",				// "TAB", "SYNC"
					// 	start: this._getDefaultStartDate(),
					// 	end: this._getDefaultEndDate(),
					// 	subject: this._getDefaultSubject(),
					// };

					// console.log(preCreateExchangeAppointment);

					// this.$.exchangeAppointments.createRecord(preCreateExchangeAppointment, TriPlatDs.RefreshType.SERVER, "actions", "preCreate").then(function() {
					// 	this.$.exchangeAppointment.refresh().then(function() {
					// 		this.$.exchangeResponse.refresh().then(function() {
					// 			this._logExchangeResponse(this.exchangeResponse);

					// 			this.$.reservationManagerEXC.refresh().then(function() {

					// 				if (this.reservationManagerEXC && this.reservationManagerEXC._id) {
					// 					this._initRM(this.reservationManagerEXC._id, null, false).then(function() {
					// 						resolve();
					// 					}.bind(this));
					// 				}
					// 			}.bind(this));
					// 		}.bind(this));
					// 	}.bind(this));
					// }.bind(this));
				} else {
					// console.log("pre-creating ReservationManager using normal method");
					var preCreate = {
						start: this._getDefaultStartDate(),
						end: this._getDefaultEndDate(),
						// userInterfaceID: "UX",
						isUX: true
					};

					this._cleanupOldRMs();

					if (this.myReservationManagers && this.myReservationManagers.length > 0) {
						var existingReservationManager = this.myReservationManagers[0];


						if (existingReservationManager && existingReservationManager._id) {
							// console.log("re-using an existing ReservationManager");

							this._initRM(existingReservationManager._id, reservationId, true).then(function() {
								resolve();
							}.bind(this));
						} else {
							this.$.myReservationManagers.createRecord(preCreate, TriPlatDs.RefreshType.SERVER, "actions", "preCreate").then(function(newId) {
								// console.log("a new id was created - " + newId);

								this._initRM(newId, reservationId, false).then(function() {
									resolve();
								}.bind(this));
							}.bind(this));
						}
					} else {
						this.$.myReservationManagers.createRecord(preCreate, TriPlatDs.RefreshType.SERVER, "actions", "preCreate").then(function(newId) {
							// console.log("a new id was created - " + newId);

							this._initRM(newId, reservationId, false).then(function() {
								resolve();
							}.bind(this));
						}.bind(this));
					}
				}
			}.bind(this));
		},

		_cleanupOldRMs: function() {

			this.$.myOldReservationManagers.refresh().then(function() {
				var myOldReservationManagers = this.myOldReservationManagers;
				var RMsToDelete = [];
				for (var index=0; index < myOldReservationManagers.length; index++) {
					var oldReservationManager = myOldReservationManagers[index];

					RMsToDelete.push(oldReservationManager._id);
				}

				if (RMsToDelete.length > 0) {
					// console.log("Deleting Old Reservation Managers", RMsToDelete);

					this.$.myOldReservationManagers.deleteRecord(RMsToDelete, TriPlatDs.RefreshType.NONE);
				}
			}.bind(this));
		},

		_initRM: function(id, reservationId, isReinit) {
			// console.log("tricomp-room-reservation._initRM");

			return new Promise(function(resolve) {
				this.reservationManagerSpecId = id;

				this.$.reservationManager.refresh().then(function() {

					if (reservationId) {
						this._openReservation(reservationId).then(function() {
							resolve();
						}.bind(this));
					} else {
						if (isReinit) {
							// console.log("_initRM: calling resetContext workflow");
							this.$.reservationManager.updateRecord(TriPlatDs.RefreshType.SERVER, "actions", "resetContext").then(function() {
								this.$.reservationLocations.refresh().then(function() {
									this.$.exceptionOccurrences.refresh().then(function() {
										this.$.reservationManagerInstance.refresh().then(function() {
											resolve();
										}.bind(this));
									}.bind(this));
								}.bind(this));
							}.bind(this));
						} else {
							resolve();
						}
					}
				}.bind(this));
			}.bind(this));
		},

		_refreshReservationList: function() {
			// console.log("_refreshReservationList");
			this._setBusy();

			this.$.reservationInstances.refresh().then(function() {
				this._clearBusy();

				if (this.$.reservationListPage) this.$.reservationListPage._refreshReservationList();
			}.bind(this));
		},

		_refreshEquipmentOrdersData: function() {
			// console.log("_refreshEquipmentOrdersData");
			this.$.reservationSummaryPage._refreshEquipmentOrdersData();
		},

		_refreshFoodOrdersData: function() {
			// console.log("_refreshFoodOrdersData");
			this.$.reservationSummaryPage._refreshFoodOrdersData();
		},

		_handleDSError: function(e) {
			var errorDetails = e.detail;
			if (errorDetails) this.set("_errorDetails", errorDetails);
			this.$.errorDialog.open();
		},

		_handleErrorDetailsCollapseOrExpand: function() {
			this.async(function() {
				this.$.errorDialog.center();
			}.bind(this), 300);
		},

		_navigate: function(navigateTo, context) {
			// console.log("_navigate");
			// console.log(navigateTo);
			// console.log(context);

			this.async(function() {
				this._switchPage(navigateTo, context);
			});
		},

		_switchPage: function(pageInstance, params) {
			// console.log("_switchPage");
			// console.log(pageInstance);
			// console.log(params);

			if (pageInstance) {
				this.set("currentPage", pageInstance.id);
				if (params) {
					pageInstance.params = params;
				}

				pageInstance._onNavigateTo();
			} else {
				console.warn("_switchPage received an invalid pageInstance.");
			}
		},

		attached: function() {
			this.async(function() {
				this.fire("init");
			});
		}
	});
</script>
